<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - MyShelf</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="main-header">
        <nav class="header-nav">
            <a href="index.html" class="header-logo">MYEVERYCOLLECTION</a>
            <a href="index.html">Home</a>
            <a href="users.html">Users</a>
            <a href="search.html">Database</a>
        </nav>
        <div class="header-tools" id="headerTools"></div>
    </header>

    <div class="login-container">
        <h1 id="form-title">Sign In</h1>
        <form id="login-form" class="action-form input">
            <input type="email" id="email" placeholder="Email" required>
            <input style="margin-top:20px;" type="password" id="password" placeholder="Password" required>
            <button type="submit" id="main-auth-btn" class="action-btn">Sign In</button>
            <button type="button" id="toggle-mode-btn" class="toggle-mode-btn">Need an account? Sign Up</button>
            <p id="auth-message" class="form-message"></p>
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script type="module">
        import { auth, db } from './firebase-config.js';

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const formTitle = document.getElementById('form-title');
        const mainAuthBtn = document.getElementById('main-auth-btn');
        const toggleModeBtn = document.getElementById('toggle-mode-btn');
        const authMessage = document.getElementById('auth-message');

        let isLoginMode = true;

        // --- Firestore Path ---
        function getFirestorePath() {
            const appId = 'default-app-id';
            // Collection for all user profiles
            return `artifacts/${appId}/user_profiles`;
        }

        // --- REDIRECT LOGIC ---
        function redirectUser() {
            // 1. Check for specific redirect param (e.g., login.html?redirect=users.html)
            const urlParams = new URLSearchParams(window.location.search);
            const redirectParam = urlParams.get('redirect');

            if (redirectParam) {
                console.log('Redirecting via URL param:', redirectParam);
                window.location.href = redirectParam;
                return;
            }

            // 2. Check referrer (previous page)
            const referrer = document.referrer;
            const currentOrigin = window.location.origin;

            // Ensure the referrer is from YOUR site and is NOT the login page itself (prevents loops)
            if (referrer && referrer.includes(currentOrigin) && !referrer.includes('login.html')) {
                console.log('Redirecting to referrer:', referrer);
                window.location.href = referrer;
            } else {
                // 3. Fallback to home
                console.log('No history found, redirecting to index.html');
                window.location.href = 'index.html';
            }
        }

        // --- Create User Profile ---
        async function createUserProfile(user) {
            const userId = user.uid;
            const email = user.email;

            // Build the data object
            const userData = {
                uid: userId,
                email: email,
                username: email.split('@')[0],
                displayName: user.displayName || '',
                photoURL: user.photoURL || '',
                accountCreationDate: firebase.firestore.FieldValue.serverTimestamp(),
                role: 'none',
                itemsOwned: 0,
                itemsWished: 0,
                itemsOrdered: 0
            };

            try {
                const collectionPath = getFirestorePath();
                await db.collection(collectionPath).doc(userId).set(userData);
                console.log(`User profile created for: ${userId}`);
            } catch (error) {
                console.error("Error creating user profile document:", error);
            }
        }

        // --- Form Submission ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;

            if (isLoginMode) {
                await handleSignIn(email, password);
            } else {
                await handleSignUp(email, password);
            }
        });

        // --- Sign In ---
        async function handleSignIn(email, password) {
            authMessage.textContent = 'Signing In...';
            authMessage.className = 'form-message';
            try {
                await auth.signInWithEmailAndPassword(email, password);
                authMessage.textContent = 'Signed in successfully! Redirecting...';
                authMessage.className = 'form-message success-message';
                
                // Delay slightly to show success message, then redirect
                setTimeout(() => {
                    redirectUser();
                }, 1000);

            } catch (error) {
                console.error("Sign in failed:", error);
                authMessage.textContent = `Sign In Failed: ${error.message}`;
                authMessage.className = 'form-message error-message';
            }
        }

        // --- Sign Up ---
        async function handleSignUp(email, password) {
            authMessage.textContent = 'Creating Account...';
            authMessage.className = 'form-message';
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Create Firestore user profile
                await createUserProfile(user);

                authMessage.textContent = 'Account created successfully! Redirecting...';
                authMessage.className = 'form-message success-message';
                
                // Delay slightly to show success message, then redirect
                setTimeout(() => {
                    redirectUser();
                }, 1000);

            } catch (error) {
                console.error("Sign up failed:", error);
                authMessage.textContent = `Sign Up Failed: ${error.message}`;
                authMessage.className = 'form-message error-message';
            }
        }

        // --- Toggle Login / Sign Up ---
        toggleModeBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                formTitle.textContent = 'Sign In';
                mainAuthBtn.textContent = 'Sign In';
                toggleModeBtn.textContent = 'Need an account? Sign Up';
            } else {
                formTitle.textContent = 'Create Account';
                mainAuthBtn.textContent = 'Sign Up';
                toggleModeBtn.textContent = 'Already have an account? Sign In';
            }
            authMessage.textContent = '';
            authMessage.className = 'form-message';
        });

    </script>
</body>

</html>
